<script>
  const ESCAPE = 27;
  const RIGHT = 39;
  const LEFT = 37;
  const TARGET_CLASS = 'target';

  const clickNavigationButton = (buttonClass) => {
    const id = window.history.state && window.history.state.id;
    if (id) {
      const selector = `#${id} ${buttonClass}`;
      const button = document.querySelector(selector);
      button && button.click();
    }
  }

  const openPhoto = (id, pushState) => {
    const photo = document.querySelector(`#${id}`);
    const title = photo.getAttribute('title');
    const href = `/${id}/`;
    removeTargetClass();
    photo.classList.add(TARGET_CLASS);
    document.title = title;
    if (pushState) {
      window.history.pushState({id: id}, '', href);
    }
  }

  const closePhoto = (pushState) => {
    const title = document.querySelector('head title').getAttribute('data-title');
    removeTargetClass();
    document.title = title;
    if (pushState) {
      window.history.pushState({}, '', '/');
    }
  }

  const removeTargetClass = () => {
    let targets = document.querySelectorAll(`.${TARGET_CLASS}`);
    targets.forEach((target) => {
      target.classList.remove(TARGET_CLASS);
    });
  }

  const handleClick = (selector, event, callback) => {
    if (event.target.matches(selector)) {
      callback();
      event.preventDefault();
    }
  }

  window.onpopstate = function(event) {
    if (event.state && event.state.id) {
      const id = event.state.id;
      openPhoto(id, false);
    } else {
      closePhoto(false);
    }
  }

  document.addEventListener('keydown', (event) => {
    if (event.keyCode === ESCAPE) {
      closePhoto(true);
    } else if (event.keyCode === RIGHT) {
      clickNavigationButton('.next');
    } else if (event.keyCode === LEFT) {
      clickNavigationButton('.previous');
    }
  });

  document.addEventListener('click', (event) => {
    handleClick('[data-target]', event, () => {
      const id = event.target.getAttribute('data-target');
      openPhoto(id, true);
    });
    handleClick('.close', event, () => {
      closePhoto(true);
    });
  });

  lazyload();
</script>
